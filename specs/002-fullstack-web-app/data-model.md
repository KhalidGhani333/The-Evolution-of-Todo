# Data Model
## Feature: Full-Stack Todo Web Application

**Branch**: `002-fullstack-web-app`
**Date**: 2026-02-03
**Phase**: 1 - Design & Contracts

---

## Entity Relationship Diagram

```
┌─────────────────────┐
│       User          │
│ (Better Auth)       │
├─────────────────────┤
│ id: text (PK)       │
│ email: text (UQ)    │
│ name: text?         │
│ email_verified: bool│
│ created_at: ts      │
│ updated_at: ts      │
└──────────┬──────────┘
           │
           │ 1:N (CASCADE)
           │
           ▼
┌─────────────────────┐
│       Task          │
├─────────────────────┤
│ id: int (PK)        │
│ user_id: text (FK)  │◄── Indexed
│ title: varchar(200) │
│ description: text?  │
│ category: varchar?  │◄── Indexed
│ completed: bool     │◄── Indexed
│ created_at: ts      │
│ updated_at: ts      │
└─────────────────────┘
```

---

## Entity: User

**Managed By**: Better Auth (authentication system)

**Purpose**: Represents an authenticated user with their own isolated task list.

### Fields

| Field | Type | Constraints | Description |
|-------|------|-------------|-------------|
| `id` | text | PRIMARY KEY, NOT NULL | UUID generated by Better Auth |
| `email` | text | UNIQUE, NOT NULL | User's email address for authentication |
| `name` | text | NULLABLE | Optional display name |
| `email_verified` | boolean | DEFAULT false | Email verification status |
| `created_at` | timestamp with timezone | NOT NULL | Account creation timestamp |
| `updated_at` | timestamp with timezone | NOT NULL | Last account update timestamp |

### Validation Rules

- **email**: Must be valid email format (RFC 5322)
- **email**: Must be unique across all users
- **name**: Optional, max 100 characters if provided

### Relationships

- **tasks**: One-to-many relationship with Task entity
  - Cascade delete: When user is deleted, all their tasks are deleted
  - Enforced by database foreign key constraint

### Indexes

- Primary key index on `id` (automatic)
- Unique index on `email` (automatic)

### State Transitions

```
[New User] --signup--> [Unverified] --verify-email--> [Verified]
                            │
                            └--signin--> [Authenticated]
```

### Security Notes

- Passwords are hashed with bcrypt (cost factor 12) before storage
- Password field managed by Better Auth (not exposed in application models)
- JWT tokens issued upon successful authentication
- Tokens contain user_id for authorization

---

## Entity: Task

**Managed By**: Application (FastAPI backend)

**Purpose**: Represents a todo item belonging to a specific user.

### Fields

| Field | Type | Constraints | Description |
|-------|------|-------------|-------------|
| `id` | integer | PRIMARY KEY, AUTO INCREMENT | Unique task identifier |
| `user_id` | text | FOREIGN KEY (users.id), NOT NULL, INDEXED | Owner of the task |
| `title` | varchar(200) | NOT NULL, CHECK (length >= 1) | Task title |
| `description` | text | NULLABLE | Optional detailed description |
| `category` | varchar(50) | NULLABLE, INDEXED | Optional category/tag |
| `completed` | boolean | DEFAULT false, INDEXED | Completion status |
| `created_at` | timestamp with timezone | NOT NULL | Task creation timestamp |
| `updated_at` | timestamp with timezone | NOT NULL | Last modification timestamp |

### Validation Rules (FR-006)

- **title**: Required, 1-200 characters, non-empty after trim
- **description**: Optional, max 1000 characters
- **category**: Optional, max 50 characters
- **completed**: Boolean, defaults to false
- **user_id**: Must reference existing user

### Relationships

- **user**: Many-to-one relationship with User entity
  - Foreign key: `user_id` → `users.id`
  - ON DELETE CASCADE: Task deleted when user is deleted
  - NOT NULL: Every task must have an owner

### Indexes

1. **idx_tasks_user_id**: Index on `user_id`
   - Purpose: Fast filtering by user (critical for user isolation)
   - Used in: All task queries (list, search, filter)

2. **idx_tasks_completed**: Index on `completed`
   - Purpose: Fast filtering by completion status
   - Used in: Status filter queries

3. **idx_tasks_category**: Index on `category`
   - Purpose: Fast filtering by category
   - Used in: Category filter queries

4. **idx_tasks_user_completed**: Composite index on `(user_id, completed)`
   - Purpose: Optimize common query pattern (user's pending/completed tasks)
   - Used in: Dashboard views, status filters

### State Transitions

```
[New Task] --create--> [Pending] --mark_complete--> [Completed]
                          │                              │
                          │                              │
                          └──────<--mark_incomplete──────┘
                          │
                          ├--update--> [Pending (modified)]
                          │
                          └--delete--> [Deleted]
```

### Business Rules

1. **User Isolation** (FR-005, FR-013):
   - All queries MUST filter by `user_id`
   - Users can only access their own tasks
   - Attempting to access another user's task returns 403 Forbidden

2. **Timestamps**:
   - `created_at` set once on creation, never modified
   - `updated_at` updated on every modification (title, description, category, completed)

3. **Soft Delete**: Not implemented (hard delete only)
   - Tasks are permanently deleted from database
   - No undo functionality (out of scope per spec)

### Query Patterns

**List all user's tasks** (FR-009):
```sql
SELECT * FROM tasks
WHERE user_id = ?
ORDER BY created_at DESC
```

**Search tasks** (FR-014):
```sql
SELECT * FROM tasks
WHERE user_id = ?
  AND (LOWER(title) LIKE ? OR LOWER(description) LIKE ?)
ORDER BY created_at DESC
```

**Filter by status** (FR-015):
```sql
SELECT * FROM tasks
WHERE user_id = ?
  AND completed = ?
ORDER BY created_at DESC
```

**Filter by category** (FR-016):
```sql
SELECT * FROM tasks
WHERE user_id = ?
  AND category = ?
ORDER BY created_at DESC
```

**Combined filters** (FR-017):
```sql
SELECT * FROM tasks
WHERE user_id = ?
  AND completed = ?
  AND category = ?
  AND (LOWER(title) LIKE ? OR LOWER(description) LIKE ?)
ORDER BY created_at DESC
```

---

## SQLModel Definitions

### Backend (Python)

```python
from sqlmodel import SQLModel, Field, Relationship
from datetime import datetime
from typing import Optional

class User(SQLModel, table=True):
    """User entity managed by Better Auth."""
    __tablename__ = "users"

    id: str = Field(primary_key=True)
    email: str = Field(unique=True, nullable=False, index=True)
    name: Optional[str] = Field(default=None, max_length=100)
    email_verified: bool = Field(default=False)
    created_at: datetime = Field(default_factory=datetime.utcnow)
    updated_at: datetime = Field(default_factory=datetime.utcnow)

    # Relationship
    tasks: list["Task"] = Relationship(back_populates="user", cascade_delete=True)


class Task(SQLModel, table=True):
    """Task entity representing a todo item."""
    __tablename__ = "tasks"

    id: Optional[int] = Field(default=None, primary_key=True)
    user_id: str = Field(foreign_key="users.id", nullable=False, index=True)
    title: str = Field(min_length=1, max_length=200, nullable=False)
    description: Optional[str] = Field(default=None, max_length=1000)
    category: Optional[str] = Field(default=None, max_length=50, index=True)
    completed: bool = Field(default=False, index=True)
    created_at: datetime = Field(default_factory=datetime.utcnow)
    updated_at: datetime = Field(default_factory=datetime.utcnow)

    # Relationship
    user: User = Relationship(back_populates="tasks")


class TaskCreate(SQLModel):
    """Schema for creating a new task."""
    title: str = Field(min_length=1, max_length=200)
    description: Optional[str] = Field(default=None, max_length=1000)
    category: Optional[str] = Field(default=None, max_length=50)


class TaskUpdate(SQLModel):
    """Schema for updating an existing task."""
    title: Optional[str] = Field(default=None, min_length=1, max_length=200)
    description: Optional[str] = Field(default=None, max_length=1000)
    category: Optional[str] = Field(default=None, max_length=50)


class TaskResponse(SQLModel):
    """Schema for task responses."""
    id: int
    user_id: str
    title: str
    description: Optional[str]
    category: Optional[str]
    completed: bool
    created_at: datetime
    updated_at: datetime
```

### Frontend (TypeScript)

```typescript
// User type (matches Better Auth)
export interface User {
  id: string;
  email: string;
  name?: string;
  emailVerified: boolean;
  createdAt: string;
  updatedAt: string;
}

// Task type
export interface Task {
  id: number;
  userId: string;
  title: string;
  description?: string;
  category?: string;
  completed: boolean;
  createdAt: string;
  updatedAt: string;
}

// Task creation payload
export interface TaskCreate {
  title: string;
  description?: string;
  category?: string;
}

// Task update payload
export interface TaskUpdate {
  title?: string;
  description?: string;
  category?: string;
}

// Zod validation schemas
import { z } from 'zod';

export const taskCreateSchema = z.object({
  title: z.string().min(1, "Title is required").max(200, "Title must be 200 characters or less"),
  description: z.string().max(1000, "Description must be 1000 characters or less").optional(),
  category: z.string().max(50, "Category must be 50 characters or less").optional(),
});

export const taskUpdateSchema = z.object({
  title: z.string().min(1, "Title is required").max(200, "Title must be 200 characters or less").optional(),
  description: z.string().max(1000, "Description must be 1000 characters or less").optional(),
  category: z.string().max(50, "Category must be 50 characters or less").optional(),
});
```

---

## Database Migration Strategy

### Initial Schema Creation

```sql
-- Users table (managed by Better Auth)
CREATE TABLE users (
    id TEXT PRIMARY KEY,
    email TEXT UNIQUE NOT NULL,
    name TEXT,
    email_verified BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE INDEX idx_users_email ON users(email);

-- Tasks table
CREATE TABLE tasks (
    id SERIAL PRIMARY KEY,
    user_id TEXT NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    title VARCHAR(200) NOT NULL CHECK (LENGTH(title) >= 1),
    description TEXT,
    category VARCHAR(50),
    completed BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE INDEX idx_tasks_user_id ON tasks(user_id);
CREATE INDEX idx_tasks_completed ON tasks(completed);
CREATE INDEX idx_tasks_category ON tasks(category);
CREATE INDEX idx_tasks_user_completed ON tasks(user_id, completed);
```

### Migration Tool

- **Tool**: Alembic (SQLAlchemy migration tool)
- **Location**: `backend/alembic/`
- **Command**: `alembic upgrade head`

---

## Data Validation Summary

| Layer | Tool | Purpose |
|-------|------|---------|
| Frontend | Zod + React Hook Form | Client-side validation, immediate user feedback |
| Backend | Pydantic (via SQLModel) | Server-side validation, security boundary |
| Database | PostgreSQL constraints | Data integrity enforcement |

**Defense in Depth**: All three layers validate to prevent invalid data at every level.

---

**Data Model Complete**: Entities defined with validation rules, relationships, and query patterns. Ready for API contract generation.
